/* 
* @Author: Town
* @Date:   2017-12-05 01:29:40
* @Last Modified by:   Town
* @Last Modified time: 2018-01-17 15:23:10
*/
$(document).ready(function(){
    
    /**
     * 响应式导航
     */ 
    $('#menu-toggle').on('click', function(e){

        $('.g-nav').slideToggle(200);

        $(document).one('click', function(){
            $('.g-nav').slideUp(200);
        });

        e.stopPropagation();
    });

    $('.g-nav').on('click', function(e){
        e.stopPropagation();
    });
    
   /**
    * 标题栏
    */
    if($(window).width() > 695) {

        var header = $('.g-header');
        var header_h = header.outerHeight();
        var appLogo = $('.g-logo');
        var navText = $('.g-nav a');

        var themeColorFlag = $('.g-banner').attr('data-theme');

        var scFlag = $(document).scrollTop();

        $(document).scroll(function(){

            var scrollTop = $(this).scrollTop();

            if(scrollTop > header_h) {

                if(scrollTop > 3*header_h) {
                    header.addClass('headerUp');
                }
                header.css({
                    'background-color': 'rgba(255, 255, 255, .98)',
                    'box-shadow': '0 1px 12px rgba(0, 0, 0, .08)'
                });
                appLogo.css({
                    'background': 'url(/assets/icons/logo_' + themeColorFlag + '.svg) no-repeat center',
                    'background-size': '100% 100%'
                });
                navText.css('color', '#666');
                $('.g-nav').addClass('nav-' + themeColorFlag);

            }else{

                header.removeClass('headerUp');
                header.css({
                    'background-color': 'transparent',
                    'box-shadow': 'none'
                });
                appLogo.css({
                    'background': 'url(/assets/icons/logo.svg) no-repeat center',
                    'background-size': '100% 100%'
                });
                navText.css('color', '#fff');
                $('.g-nav').removeClass('nav-' + themeColorFlag);

            }
            // 滚动动作
            if(scFlag > scrollTop) {
                header.addClass('headerDown');
            }else{
                header.removeClass('headerDown');
            }
            scFlag = scrollTop;
        });
    }

    /*
    *后套的调整
    */
    function postCover(img, container) {
        var imgWidth = img.width(),
            containerWidth = container.width(),
            imgHeight = img.height(),
            containerHeight = container.height();
        var isOk = false;
        if(imgHeight < containerHeight) {
            img.css({
                'width': 'auto',
                'height': '100%'
            });
            imgWidth = img.width(),
            containerWidth = container.width();
            var marginLeft = (imgWidth - containerWidth) / 2;
            img.css('margin-left', '-' + marginLeft + 'px');
            isOk = true;
        } else {
            var marginTop = (containerHeight - imgHeight) / 2;
            img.css('margin-top', marginTop + 'px');
            isOk = true;
        }

        if(isOk) {
            img.fadeIn();
            isOk = false;
        }
    }

    /**
     * 后导航仪
     */
    $('.read-next-item section').each(function(){
        var _this = $(this),
            n = _this.height(),
            rn = $('.read-next-item').height();
        _this.css('margin-top', (rn-n)/2 + 'px');
        _this.fadeIn();
    });

    $('.read-next-item img').each(function(){
        var _this = $(this);
        postCover(_this, $('.read-next-item'));
    });

    /**
     * 分页
     */
    function pagination() {
        var total = parseInt($('#total_pages').val()),
            current = parseInt($('#current_pages').val()),
            baseUrl = $('#base_url').val(),
            limit = 3;

        var link_html = '';

        for(var i = current - limit; i<current; i++) { 
            if(i>0 && i!==1) {
                link_html += '<a href="' + baseUrl + 'page' + i + '" class="page-link page-num">' + i + '</a>';
            }else if(i===1) {
                link_html += '<a href="' + baseUrl + '" class="page-link page-num">' + i + '</a>';
            }
        }

        link_html += '<span class="page-link page-num active">' + current + '</span>';

        for(var j = current + 1; j<=current + limit; j++) { 
            if(j<=total) {
                link_html += '<a href="' + baseUrl + 'page' + j + '" class="page-link page-num">' + j + '</a>';
            }
        }
        
        $('#page-link-container').html(link_html);
    }
    pagination();

    /**
     * 搜索
     */  
    function Search() {
        var self = this,
            input = $('#search_input'),
            result = $('.search_result');
        
        input.focus(function() {
            $('.icon-search').css('color', '#3199DB');
            result.show();
        });

        input.keyup(debounce(this.autoComplete));

        $(document).click(function(e) {
            if(e.target.id === 'search_input' || e.target.className === 'search_result' || e.target.className === 'search_item') {
                return;
            }
            $('.icon-search').css('color', '#CAD3DC');
            result.hide();
        });
    }

    Search.prototype.autoComplete = function() {
        var keywords = this.value.toLowerCase();
        
        if(keywords.length) {
            $('.icon-search').css('color', '#3199DB');
        }else{
            $('.icon-search').css('color', '#CAD3DC');
        }

        $.getJSON('../../search.json').done(function(data) {
            var html = '';
            for (var i in data) {
                var item = data[i],
                    title = item.title,
                    tags = item.tags,
                    url = item.url;

                var k = title + tags;
                if(keywords !== '' && k.toLowerCase().indexOf(keywords) >= 0) {
                    html += '<a class="search_item" href="' + item.url + '">' + item.title + '</a>';
                }
            }
            $('.search_result').html(html);
        });
    };

    function debounce(fn, delay) {
        var timer;
        delay = delay || 120;

        return function() {
            var ctx = this,
                args = arguments,
                later = function() {
                    fn.apply(ctx, args);
                };
            clearTimeout(timer);
            timer = setTimeout(later, delay);
        };
    }

    new Search();

    /**
     * 夜间模式
     */
    function nightMode() {
        var el = $('body'),
            className = 'night-mode';

        var date = new Date(),
            hour = date.getHours();

        if((hour >= 0 && hour <= 6) || hour === 23) {
            el.addClass(className);
        }
    }
    
    if($('#nm-switch').val() === 'true') {
        nightMode();
    }

    /**
     * 复制版权
     */
    function setClipboardData(str) {
        str += '\n\n著作权归作者所有。\n商业转载请联系作者获得授权,非商业转载请注明出处。\n原文: ' + location.href;
        $('.post-content').on('copy', function(e) {
            var data = window.clipboardData || e.originalEvent.clipboardData;
            data.setData('text/plain', str);
            e.preventDefault();
        }); 
    }
    $('.post-content').on('mouseup', function(e) {
        var txt = window.getSelection();
        if(txt.toString().length >= 30) {
            setClipboardData(txt);
        }
    });
  
//技能图绘制插件
    (function() {
            var Radar = function(cfg) {
            var outContainer = document.querySelector(cfg.el);
            var container = document.createElement("div");
            var cans = document.createElement("canvas");
            container.appendChild(cans);
            outContainer.appendChild(container);

            var ctx = cans.getContext("2d");
            var data = cfg.data;
            var w = cfg.width;
            var h = cfg.height;
            container.style.position = "relative";
            container.style.width = w+"px";
            container.style.height = h+"px";
            cans.width = w;
            cans.height = h;

            var step = data.length;
            var r = w/2;

            //绘制网格背景
            var isBlue = false;

            for(var s = 10; s > 0; s--) {
                ctx.beginPath();
                for(var i=0;i<step;i++) {
                    var rad = 2*Math.PI/step * i;
                    var x = r + Math.sin(rad)*r*(s/10);
                    var y = r + Math.cos(rad)*r*(s/10);
                    ctx.lineTo(x, y);
                }
                ctx.closePath();
                ctx.fillStyle = (isBlue = !isBlue)?'#99c0ff' : '#f1f9ff';
                ctx.fill();
            }


            //绘制伞骨
            ctx.beginPath();
            for(var i=0;i<step;i++) {
                var rad = 2*Math.PI/step * i;
                var x = r + Math.sin(rad)*r;
                var y = r + Math.cos(rad)*r;
                ctx.moveTo(r,r);
                ctx.lineTo(x, y);

                var text = document.createElement("div");
                text.innerHTML = data[i][0];
                text.style.position = "absolute";

                //添加文本
                if(x > r) {
                    text.style.left = ( x + 10) + 'px';
                } else {
                    text.style.right = (w-x +5) + 'px';
                }

                if(y > r) {
                    text.style.top = y + 'px';
                } else {
                    text.style.bottom = (h - y) + 'px';
                }
                container.appendChild(text);
            }
            ctx.strokeStyle = "#e0e0e0"
            ctx.stroke();

            //绘制折线
            ctx.strokeStyle = "#f00";
            ctx.beginPath();

            for(var i=0;i<step;i++) {
                var rad = 2*Math.PI/step * i;
                var x = r + Math.sin(rad)*r*data[i][1];
                var y = r + Math.cos(rad)*r*data[i][1];
                ctx.lineTo(x,y);
            }
            ctx.closePath();
            ctx.stroke();

            //添加数据点
            ctx.fillStyle = "#ff7676";
            for(var i=0;i<step;i++) {
                var rad = 2*Math.PI/step * i;
                var x = r + Math.sin(rad)*r*data[i][1];
                var y = r + Math.cos(rad)*r*data[i][1];
                ctx.beginPath();
                ctx.arc(x,y,4,0,2*Math.PI);
                ctx.fill();
                ctx.closePath();
            }


        }
        window["Radar"] = Radar;
    })();
/**
 * [radar description]
 * @type {Radar}
 * 技能图绘制调用方法
 */
    var radar = new Radar({
    el: "#skill",
    width: 300,
    height: 300,
    data: [["HTML", 0.5], ["CSS", 0.6], ["JS", 0.2], ["jQuery", 0.1],
     ["Android", 0.9],["java",0.7],["Sql",0.3],["SQlite",0.5],["Kotlin",0.1]]
});

});

